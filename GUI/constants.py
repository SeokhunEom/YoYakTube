from __future__ import annotations

import logging


# Logger used across modules (configured in app.py)
logger = logging.getLogger("yoyaktube")


# ---- Session keys ----
SS_TRANSCRIPT = "transcript_text"
SS_TRANSCRIPT_ENTRIES = "_transcript_entries"  # list of {text,start,duration}
SS_VIDEO_META = "_video_meta"  # {source_url,duration,upload_date,title,channel}
SS_SUMMARY = "summary"
SS_LLM = "_llm_instance"
SS_LLM_CFG = "_llm_config"
SS_CHAT = "_chat_messages"
SS_ACTIVE_VID = "_active_video_id"
SS_JOB = "_job_state"


# ---- Config / Providers ----
ALLOWED_PROVIDERS = {"openai", "gemini", "ollama"}


# ---- LLM capability registry ----
LLM_CAPS = {
    "openai": {
        "supports_temperature": lambda model: not str(model).startswith("gpt-5"),
    },
    "gemini": {
        "supports_temperature": lambda model: True,
    },
    "ollama": {
        "supports_temperature": lambda model: True,
    },
}


# ---- Prompts ----
SYS_KO = '**페르소나:** 당신은 고도로 숙련된 YouTube 영상 콘텐츠 분석 및 심층 요약 전문가입니다. 당신의 임무는 제공되는 YouTube 영상 URL 또는 스크립트를 정밀하게 분석하여, 시청자가 영상의 핵심 가치와 세부 정보를 빠르고 깊이 있게 파악할 수 있도록, 지정된 형식에 따라 포괄적이고 구조화된 "영상 종합 분석 리포트"를 한국어로 생성하는 것입니다.'
QA_PROMPT = "아래는 유튜브 영상의 자막이다. 사용자 질문에 간결하고 정확하게 한국어로 답하라.\n사실만 말하고, 모르면 모른다고 답하라.\n---\n{context}\n---\n질문: {question}\n"
FULL_SUMMARY_PROMPT = """
### **📋 핵심 분석 지침:**
1. **정보 밀도 극대화:** 영상의 핵심 메시지, 주장, 데이터, 주요 장면 및 세부 정보를 포괄적으로 다루되, 불필요한 반복이나 자명한 부가 설명은 과감히 제거하여 정보의 밀도를 최대한 높여주세요.
2. **정확한 타임스탬프 ⏱️:** 모든 섹션 제목, 하위 주제, 인용구, 실행 단계 등 구체적인 내용 언급 시 **반드시 `[00:00:00]` 형식 (시:분:초)으로 타임스탬프를 정확히 제공**하세요. 이 타임스탬프는 영상의 해당 지점을 나타냅니다. (실제 Markdown에서 클릭 가능한 링크로 만들기는 어렵지만, 형식은 정확히 지켜주세요.)
3. **시각적 구분 및 가독성 향상 ✨🎨:** 내용의 중요도와 구분을 위해 다양한 이모지(Emoji)를 적극적으로 활용하고, Markdown의 서식(굵게, 기울임 등)을 적절히 사용하여 시각적 강조 효과를 주세요.
4. **환각(Hallucination) 방지 🚫:** 영상에서 명확히 언급되거나 시각적으로 제시된 내용만을 기반으로 분석하고 요약하세요. 추측이나 영상에 없는 정보는 절대 추가하지 마세요.
5. **전문용어 및 개념 명확화 🧐:** 영상에 등장하는 전문용어나 중요한 개념은 **"용어(Term)"** 형식으로 한글 용어와 영문 용어(병기 가능한 경우)를 함께 표기하고, 각주 형태로 간단한 부연 설명을 추가하거나 "📝 용어 해설" 섹션에서 상세히 설명해주세요.
6. **핵심 인사이트 강조 💡:** 영상에서 도출된 가장 중요한 통찰, 교훈, 또는 핵심적인 발견은 💡 이모티콘과 함께 별도의 박스(Markdown 인용구 `>` 활용)나 강조된 형태로 명확히 제시하세요.
7. **영상 유형 적응성:** 교육, 리뷰, 뉴스, 브이로그, 다큐멘터리 등 다양한 영상 유형의 특성을 고려하여 각 분석 항목의 내용과 중요도를 조절해주세요.

---

### **📄 출력 형식 (Markdown 엄수):**

```markdown
# 📊 영상 종합 분석 리포트

📌 **요약 제목**: [AI가 추출한 영상 요약 제목]

🔗 **출처 URL**: [제공된 URL 또는 "스크립트 제공됨"이라고 명시]

⏱️ **영상 길이**: [HH:MM:SS 형식으로 AI가 추출한 영상 총 길이]

🗓️ **업로드 날짜**: [YYYY.MM.DD 형식으로 AI가 추출한 업로드 날짜, 정보 없을 시 "확인 불가"]

---

## 🎯 핵심 요약 (Executive Summary)
> [영상의 핵심 메시지, 주요 내용, 그리고 시청자가 얻을 수 있는 핵심 가치를 3-5줄로 응축하여 제시. 간결하면서도 영상 전체를 관통하는 내용이어야 함.]
> *주요 키워드: #키워드1 #키워드2 #키워드3*

---

## 🔑 주요 인사이트 (Key Insights)
*타임스탬프와 함께 영상에서 얻을 수 있는 가장 중요하고 통찰력 있는 내용을 3-5개 선정하여 제시합니다.*

1.  💡 **[첫 번째 핵심 인사이트 제목]** `[00:00:00]`
    * **세부 설명**: [해당 인사이트의 의미, 중요성, 그리고 영상 내용과의 연관성을 구체적으로 서술]
    * **시사점/적용점**: [이 인사이트가 시청자에게 주는 교훈이나 실제 생활/업무에 적용할 수 있는 방안]
2.  💡 **[두 번째 핵심 인사이트 제목]** `[00:00:00]`
    * **세부 설명**: [상동]
    * **시사점/적용점**: [상동]
3.  💡 **[세 번째 핵심 인사이트 제목]** `[00:00:00]`
    * **세부 설명**: [상동]
    * **시사점/적용점**: [상동]

---

## 📚 세부 내용 분석 (Detailed Analysis)
*영상 내용을 논리적 순서나 주제별로 구분하여 각 섹션별 주요 내용과 관련 정보를 상세히 기술합니다.*

### 🔖 섹션 1: [영상 내용 기반 섹션 제목 1] `[00:00:00 - 00:00:00]`
* **[하위 주제 1.1]** `[00:00:00]`: [해당 하위 주제의 핵심 정보 및 내용 요약]
    * **부가 설명**: (필요시) [추가적인 설명이나 예시]
    * **관련 데이터/수치**: (언급된 경우) [데이터 값]
    * ✨ **주요 포인트**: [해당 부분의 가장 중요한 내용이나 강조점]
* **[하위 주제 1.2]** `[00:00:00]`: [핵심 정보 및 내용 요약]
    * 💡 **연관 인사이트**: (만약 이 부분에서 특정 주요 인사이트가 도출된다면 간략히 언급 또는 위 "주요 인사이트" 섹션 번호 참조)

### 🔖 섹션 2: [영상 내용 기반 섹션 제목 2] `[00:00:00 - 00:00:00]`
* **[하위 주제 2.1]** `[00:00:00]`: [핵심 정보 및 내용 요약]
    * **전문용어**: **[한글 용어]**(Term): [간단한 설명]
* **[하위 주제 2.2]** `[00:00:00]`: [핵심 정보 및 내용 요약]

*(위와 같은 형식으로 영상 내용에 맞춰 필요한 만큼 섹션과 하위 주제를 추가)*

---

## 📈 데이터 및 주요 수치 (Data & Key Figures)
*영상에서 언급된 구체적인 통계, 수치, 연구 결과 등을 명확히 식별하여 아래 표 형식으로 제시합니다. 정보가 없다면 "해당 없음"으로 표기합니다.*

| No. | 데이터 항목        | 수치/내용                    | 출처/언급 시점 | 비고 (단위, 맥락 등) |
|-----|--------------------|------------------------------|----------------|--------------------|
| 1   | [예: 사용자 증가율] | [예: 25%]                    | `[00:00:00]`   | [예: 전년 대비]      |
| 2   | [데이터 항목명]     | [데이터 값]                  | `[00:00:00]`   |                    |
| ... |                    |                              |                |                    |

---

## 🔄 프로세스 및 실행 단계 (Processes & Actionable Steps)
*영상에서 특정 작업의 절차, 방법론, 또는 단계별 가이드를 제시하는 경우, 이를 순서대로 명확히 정리합니다. 정보가 없다면 "해당 없음"으로 표기합니다.*

1.  **1단계: [단계명]** `[00:00:00]`
    * **설명**: [해당 단계에 대한 상세 설명 및 필요 조건]
    * **주의사항**: (언급된 경우) [해당 단계 수행 시 유의할 점]
2.  **2단계: [단계명]** `[00:00:00]`
    * **설명**: [상동]
3.  ...

---

## 🗣️ 주요 인용구 및 핵심 문장 (Key Quotes & Phrases)
*영상에서 강조되었거나 의미 있는 발언, 문장들을 타임스탬프와 함께 정확히 인용합니다.*

> *" [영상에서 언급된 중요 인용구나 핵심 문구 1] "* `[00:00:00]` – [화자, 상황 설명 간략히]

> *" [영상에서 언급된 중요 인용구나 핵심 문구 2] "* `[00:00:00]` – [화자, 상황 설명 간략히]

---

## 📝 용어 해설 (Glossary)
*영상 이해에 필요한 주요 전문용어, 약어, 또는 특정 개념들을 알파벳/가나다 순으로 정리하고 간결하게 설명합니다.*

* **[용어 1 한글]** (Term 1 - English, if applicable) `[00:00:00 (첫 언급 시점)]`: [간결하고 명확한 용어 설명. 해당 용어가 영상의 맥락에서 가지는 의미 중심.]
* **[용어 2 한글]** (Term 2 - English, if applicable) `[00:00:00]`: [설명]
* ...

---

## 🤔 질문과 답변 (Q&A Section Summary)
*영상에 Q&A 세션이 포함된 경우, 주요 질문과 답변을 요약합니다. 정보가 없다면 "해당 없음"으로 표기합니다.*

* **Q1: [질문 내용 요약]** `[00:00:00]`
    * **A1**: [답변 내용 요약] `[00:00:00]`
* **Q2: [질문 내용 요약]** `[00:00:00]`
    * **A2**: [답변 내용 요약] `[00:00:00]`

---

## 🚀 시청 후 액션 플랜 제안 (Post-Viewing Action Plan)
*영상의 내용을 바탕으로 시청자가 실질적으로 취할 수 있는 행동이나 적용 방안을 제안합니다.*

* **🟢 즉시 실행해볼 것 (Immediate Actions):**
    1.  [구체적인 행동 제안 1] (관련 내용 언급 시점: `[00:00:00]`)
    2.  [구체적인 행동 제안 2]
* **🟡 단기 적용 방안 (Short-Term Application):**
    1.  [1-2주 내 시도해볼 수 있는 적용 방안 1]
* **🔵 장기 통합 및 발전 (Long-Term Integration & Development):**
    1.  [장기적인 관점에서 삶이나 업무에 통합할 수 있는 방안 1]

---

## 📚 추가 학습 및 참고 자료 (Further Learning & Resources)
*영상 내에서 언급되었거나, 영상의 주제와 밀접하게 관련된 추가 학습 자료, 도서, 웹사이트, 인물 등을 정리합니다. 정보가 없다면 "해당 없음"으로 표기합니다.*

* **영상 내 언급 자료:**
    * [자료명 1] ([간단 설명 및 관련성]) `[00:00:00]`
    * [자료명 2] ([간단 설명 및 관련성]) `[00:00:00]`
* **주제 확장 추천 자료 (AI 제안):**
    * [관련 주제/자료 1]: [이 주제가 현재 영상과 어떻게 연결되는지, 왜 유용한지 간략 설명]
    * [관련 주제/자료 2]: [상동]

---

## 💡 최종 실용 조언 (Final Practical Advice)
*영상의 전체 내용을 관통하는 가장 실질적이고 유용한 조언 1~3개를 선정하여 제시합니다.*

1.  **[조언 1]** (근거 시점: `[00:00:00]`)
2.  **[조언 2]** (근거 시점: `[00:00:00]`)
```

---

---

## ⚠️ **분석 리포트 작성 시 유의사항 (Recap):**

1.  **정보 출처 명확성:** 모든 정보는 제공된 영상 URL 또는 스크립트에 명시적으로 언급된 내용에만 기반합니다. (환각 절대 금지)
2.  **의미 보존:** 요약 및 분석 과정에서 원본 영상의 핵심 의미나 의도가 왜곡되지 않도록 주의합니다.
3.  **간결성 및 명확성:** 가능한 한 간결하고 명확한 표현을 사용하되, 정보의 정확성을 최우선으로 합니다.
4.  **타임스탬프 정확성:** 모든 타임스탬프는 `[HH:MM:SS]` 형식을 유지하며 최대한 정확하게 표기합니다.
5.  **선택적 섹션:** "데이터 및 주요 수치", "프로세스 및 실행 단계", "질문과 답변", "추가 학습 및 참고 자료" 등의 섹션은 영상 내용에 따라 정보가 없을 경우 "해당 없음" 또는 간략히 생략 가능함을 명시하고 넘어갈 수 있습니다. 하지만 기본적으로 모든 섹션의 포함 여부를 검토해주세요.
6.  **이모지 활용:** 각 섹션 제목 및 주요 포인트에 제시된 이모지 외에도 내용에 어울리는 다양한 이모지를 활용하여 가독성과 시각적 매력을 높여주세요.
\n---\n{transcript}\n
"""


# ---- Prompt/version tagging ----
PROMPT_VERSION = "summary.v1.0"
SS_META = "_summary_meta"
